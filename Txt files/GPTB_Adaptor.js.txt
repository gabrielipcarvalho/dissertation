// File: GPTB_Adaptor.js

// Import necessary libraries
const { Configuration, OpenAIApi } = require("openai");
const fs = require("fs");
require('dotenv').config();

// Configuration
const configuration = new Configuration({
    apiKey: process.env.OPENAI_API_KEY,
});
const openai = new OpenAIApi(configuration);

// Utility function to read and validate data logged by GPTA
const readAndValidateData = async (filename) => {
    try {
        const dataJson = await fs.promises.readFile(filename, { encoding: 'utf8' });
        const data = JSON.parse(dataJson);
        
        if (!data || (typeof data !== 'object')) {
            throw new Error('Invalid data format');
        }
        return data;
    } catch (error) {
        console.error(`Error processing file: ${filename}`, error);
        throw error;
    }
};

// Function to analyze how news and sentiment affected stock price fluctuations
const analyzeImpactOnStockPrices = async (extractedInfo, sentimentAnalysis, day) => {
    const modelVersion = "text-davinci-003"; // or the latest available model
    const prompt = `Given the extracted information and its sentiment analysis from news articles related to the stock market for ${day}, please conduct a thorough analysis to identify how these factors might influence stock price movements. Consider the following aspects in your analysis:\n\n1. **Relevance to Stock Prices**: Highlight the direct relevance of the extracted information to stock market trends. Specify whether any company earnings reports, policy changes, market sentiment shifts, or geopolitical events are mentioned, and their potential impact on stock prices.\n\n2. **Sentiment Influence**: Evaluate how the sentiment conveyed by the news (positive, negative, neutral) correlates with potential or observed stock price movements. Discuss whether the sentiment could lead to increased trading volume, market optimism/pessimism, or price volatility.\n\n3. **Causative Links**: Attempt to establish causative links between the news sentiment and stock price fluctuations. Are there any clear patterns indicating that certain types of news or sentiment have a consistent impact on the stock prices?\n\n4. **Comparative Analysis**: If applicable, compare the impact of the current day's news and sentiment with previous days' data. Identify any cumulative effects or changing trends that could inform future stock price predictions.\n\n5. **Potential Anomalies or Exceptions**: Note any anomalies or exceptions where the expected impact of news sentiment did not align with actual stock price movements. Suggest possible reasons for these discrepancies.\n\nYour analysis should provide a comprehensive overview of how news and sentiment analysis from ${day} can influence stock market behavior, highlighting specific examples and causative links where possible.`;


    try {
        const response = await openai.createCompletion({
            model: modelVersion,
            prompt: prompt,
            temperature: 0.5,
            max_tokens: 1024,
            top_p: 1.0,
            frequency_penalty: 0.0,
            presence_penalty: 0.0,
        });

        const impactAnalysis = response.data.choices[0].text.trim();
        fs.writeFileSync(`log.GPTB.${day}.impact.json`, JSON.stringify({ impactAnalysis }, null, 2));
        return impactAnalysis;
    } catch (error) {
        console.error(`Error analyzing impact on stock prices for ${day}:`, error);
        throw error;
    }
};

// Example usage
(async () => {
    const day = 'day0'; // Example day
    try {
        const extractedInfoData = await readAndValidateData(`log.GPTA.${day}.news.json`);
        const sentimentAnalysisData = await readAndValidateData(`log.GPTA.${day}.sentiment.json`);
        
        const impactAnalysis = await analyzeImpactOnStockPrices(extractedInfoData.extractedInformation, sentimentAnalysisData.sentimentAnalysis, day);
        console.log(`Impact Analysis for ${day}:`, impactAnalysis);
    } catch (error) {
        console.error("Error in GPTB Adaptor execution:", error);
    }
})();
